# Turmas - Relatório

Para a fase 3 do projeto, foi decidida uma abordagem genérica para o __*gossip*__ por forma a suportar qualquer número de servidores (primários ou secundários).

Para concretizar esta abordagem, foi desenhada um solução baseada em __*Lazy Replication*__. O __*Lazy Replication*__ dá ao cliente garantias de que, uma vez visto um estado *S*, não poderá ver um estado *S'* menos atualizado do que *S*. Para este efeito foram utilizados __*Vector Clocks*__, que também serão úteis mais à frente. Foram também usados os seguintes conceitos:

- __*Update Log*__ - mantém um log das operações executadas numa dada réplica entre "rounds" de __*gossip*__

- __*Operation Table*__ - guarda as operações que já foram executadas numa réplica, por forma a que não venham a ser executadas uma segunda vez

Foram então utilizados estes conceitos para contruir uma rede de comunicação entre réplicas, a qual é utilizada quando chega a altura de executar o __*gossip*__. Uma vez despultado o __*gossip*__, cada réplica irá enviar o seu __*Update Log*__ a todas as outras réplicas por forma a que estas possam ter acesso às operações que não foram executadas em si mesma. As réplicas esperam durante um dado período de tempo por estas mensagens, se uma réplica não enviar o seu __*Update Log*__ neste tempo útil, é presumida como desativada ou com o __*gossip*__ desativado. Uma vez recebidos todos os __*Update Logs*__ possíveis, é executado um algoritmo de "merge" dos __*Update Logs*__. Esta algoritmo orderna os __*Update Logs*__ por ordem do tempo lógico de cada réplica (usando __*Vector Clocks*__ que são passados entre as mesmas) e infere quais são as operações que realmente devem ser aplicadas ao estado da **Turma**. É também tomado em atenção conflitos como a capacidade da turma e os alunos inscritos, os quais são resolvidos pela mesma estratégia: ordenação e seleção. A ordenação tanto dos __*Update Logs*__ como dos alunos é um fator importante pois as réplicas nunca terão garantias de que receberão os __*Update Logs*__ pela mesma ordem. Desta forma, é possível obter um estado coerente em cada réplica.

A conceção do algoritmo previne também o caso em que uma réplica é desativada ou em que o seu __*gossip*__ é desativado. Os __*Update Logs*__ de cada réplica só são limpos uma vez recebidas N - 1 mensagens no total (sendo N o número de servidores), por forma a que réplicas que venham a despertar no futuro possam ainda ser atualizadas. Entra aqui em jogo a __*Operation Table*__ para prevenir que uma réplica aplique a mesma operação duas vezes ao ser verificada aquando de aplicar a mesma, prevenindo assim que se polua o estado da **Turma**.

Para o **Admin** foi tomada a decisão de não o restringir às garantias do __*Lazy Replication*__ por forma a ter acesso total aos servidores com que deseja interagir. Os seus comandos foram também tornados genéricos para serem mais coerentes e corretos no contexto em que existem vários servidores. Ou seja, cada comando do __*Admin*__ é aplicado a todos os servidores que sejam especificados com __qualifiers__ passados como agumento (ex.: "deactivateGossip S" desativa o __*gossip*__ de todos os servidores secundários).